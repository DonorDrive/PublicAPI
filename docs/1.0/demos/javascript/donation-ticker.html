<html>
	<head>
		<script src="https://cdn.jsdelivr.net/npm/moment@2.20.1/moment.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/numeral@2.0.6/numeral.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<!--<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>-->
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
	</head>
	<body>
		<div id="app" class="container-fluid">
			<div class="row">
				<div class="col"><h1>Shift: {{ entity.sumShiftDonations | formatMoney }}</h1></div>
				<div class="col"><h1>Total: {{ entity.sumDonations | formatMoney }}</h1></div>
			</div>
			<div class="row">
				<div class="col">
					<table class="table">
						<thead>
							<tr>
								<th scope="col">Date</th>
								<th scope="col">$</th>
								<th scope="col">Name</th>
								<th scope="col">Message</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="donation in donations" v-bind:key="donation.donationID" v-bind:class="{ 'table-primary': donation.amount >= 50 }">
								<td>{{ donation.createdDateUTC | formatDate }}</td>
								<td>{{ donation.amount | formatMoney }}</td>
								<td>{{ donation.displayName }}</td>
								<td>{{ donation.message }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<div class="float-right">
						<button type="button" class="btn btn-link" v-on:click="resetShift">Reset Shift</button>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
		var api = 'https://www.extra-life.org/api/',
			resource = 'participants',
			resourceID = 348319,
			limit = 50;

		Vue.filter(
			'formatDate',
			(value) => {
				return moment(value).format('MM/DD/YYYY hh:mm');
			}
		);

		Vue.filter(
			'formatMoney',
			(value) => {
				return numeral(value).format('$0,0.00');
			}
		);

		var v = new Vue({
			data: {
				donations: [],
				entity: {
					etag: ''
				}
			},
			el: '#app',
			methods: {
				refreshDonations() {
					axios.get(api + '/' + resource + '/' + resourceID + '/donations' + ( api.indexOf('?') >= 0 ? '&' : '?' ) + 'limit=' + limit)
						.then((response) => {
							this.donations = response.data;
						});
				},
				refreshEntity() {
					axios.get(api + '/' + resource + '/' + resourceID)
						.then((response) => {
							// success
							if(response.headers.etag != this.entity.etag) {
								var e = response.data;
								e.etag = response.headers.etag;

								if(!window.localStorage.getItem('startingSumDonations')) {
									window.localStorage.setItem('startingSumDonations', e.sumDonations);
								}

								e.sumShiftDonations = ( e.sumDonations - numeral(window.localStorage.getItem('startingSumDonations')).value() );

								this.entity = e;

								v.refreshDonations();
							}
						});
				},
				resetShift() {
					window.localStorage.removeItem('startingSumDonations');

					this.entity.etag = '';

					v.refreshEntity();
				}
			}
		});

		setInterval(
			() => {
				v.refreshEntity();
			},
			15000
		);

		v.refreshEntity();
	</script>
</html>